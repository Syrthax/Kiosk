# ──────────────────────────────────────────────────────────────
# Kiosk — Windows Build via GitHub Actions
# ──────────────────────────────────────────────────────────────
# Triggers:
#   • Push to main  → builds and uploads artifact to the run
#   • Git tag v*     → creates a GitHub Release with the .msi/.exe
#
# What it does:
#   1. Checks out repo
#   2. Installs Rust (stable, windows target)
#   3. Installs Node 20
#   4. Downloads PDFium DLL for Windows
#   5. Installs frontend dependencies
#   6. Builds the Tauri app for Windows
#   7. Uploads the installer artifacts
# ──────────────────────────────────────────────────────────────

name: Build Windows

on:
  push:
    branches: [main]
    tags: ["v*w"]          # e.g. v0.1.0w — Windows releases only
  workflow_dispatch:       # manual trigger from GitHub UI

# Only allow one build per ref at a time; cancel older runs
concurrency:
  group: build-windows-${{ github.ref }}
  cancel-in-progress: true

env:
  # PDFium version — update this when upgrading
  # Using pdfium-binaries from bblanchon (widely used open-source builds)
  PDFIUM_VERSION: "6721"

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        # All commands run inside the Tauri project directory
        working-directory: "Desktop (Tauri)/Kiosk"

    steps:
      # ── 1. Checkout ──────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Install Rust ──────────────────────────────────────
      # Installs the stable Rust toolchain. The windows-latest runner
      # already has MSVC build tools, so no extra C++ toolchain needed.
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # Cache Cargo registry + build artifacts to speed up subsequent builds
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            Desktop (Tauri)/Kiosk/src-tauri/target
          key: windows-cargo-${{ hashFiles('Desktop (Tauri)/Kiosk/src-tauri/Cargo.lock') }}
          restore-keys: windows-cargo-

      # ── 3. Install Node.js ───────────────────────────────────
      - name: Install Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ── 4. Install frontend dependencies ─────────────────────
      - name: Install npm dependencies
        run: npm ci

      # ── 5. Download PDFium for Windows ───────────────────────
      # Your app uses pdfium-render which dynamically loads pdfium.dll
      # at runtime. We download the pre-built PDFium binary from
      # bblanchon/pdfium-binaries (the official source recommended by
      # pdfium-render docs) and place it where Tauri can bundle it.
      - name: Download PDFium for Windows
        shell: pwsh
        run: |
          $pdfiumUrl = "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-win-x64.tgz"
          $tgzPath = "$env:TEMP\pdfium-win-x64.tgz"
          $extractPath = "$env:TEMP\pdfium"

          Write-Host "Downloading PDFium for Windows from bblanchon/pdfium-binaries..."
          Invoke-WebRequest -Uri $pdfiumUrl -OutFile $tgzPath

          Write-Host "Extracting .tgz..."
          New-Item -ItemType Directory -Force -Path $extractPath | Out-Null
          tar -xzf $tgzPath -C $extractPath

          # Find pdfium.dll (typically in bin/ directory)
          $dll = Get-ChildItem -Path $extractPath -Recurse -Filter "pdfium.dll" | Select-Object -First 1
          if (-not $dll) {
            Write-Error "pdfium.dll not found in archive! Contents:"
            Get-ChildItem -Path $extractPath -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

          # Copy to src-tauri directory so Tauri bundles it alongside the exe
          $targetDir = "src-tauri"
          Copy-Item $dll.FullName -Destination "$targetDir\pdfium.dll" -Force
          Write-Host "pdfium.dll copied to $targetDir\pdfium.dll"
          Write-Host "File size: $([math]::Round((Get-Item "$targetDir\pdfium.dll").Length / 1MB, 2)) MB"

      # ── 6. Build the Tauri app ───────────────────────────────
      # `npx tauri build` will:
      #   - Run `npm run build` (vite build for frontend)
      #   - Compile the Rust backend in release mode
      #   - Bundle into .msi and .exe (NSIS) installers
      - name: Build Tauri app for Windows
        run: npx tauri build
        env:
          # Tauri needs this to skip code signing on CI
          TAURI_SIGNING_PRIVATE_KEY: ""

      # ── 7. Upload build artifacts ────────────────────────────
      # Uploads .msi and .exe so you can download them from the
      # Actions run page (even without a release tag).
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kiosk-windows-installers
          path: |
            Desktop (Tauri)/Kiosk/src-tauri/target/release/bundle/msi/*.msi
            Desktop (Tauri)/Kiosk/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error

      # ── 8. Create GitHub Release (only on tag push) ──────────
      # When you push a tag like `v0.1.0`, this creates a GitHub
      # Release and attaches the installers as downloadable assets.
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Desktop (Tauri)/Kiosk/src-tauri/target/release/bundle/msi/*.msi
            Desktop (Tauri)/Kiosk/src-tauri/target/release/bundle/nsis/*.exe
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
